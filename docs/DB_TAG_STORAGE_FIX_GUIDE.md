# DB 태그(tagKr/tagsKr) 저장 형식 가이드 및 수정 방법

## 1. 왜 `["PPT"`, `"스토리텔링"`, `"슬라이드"]` 처럼 보이나요?

도구 상세 페이지의 태그가 **대괄호 `[` `]`와 따옴표 `"`까지 그대로** 보이는 이유는,  
태그가 **배열이 아니라 문자열**로 저장되었거나, **문자열을 쉼표로만 잘라서** 쓰고 있기 때문입니다.

- 예: DB에 `tagKr`이 **문자열** `'["PPT", "스토리텔링", "슬라이드"]'` 로 저장됨  
- 어딘가에서 이 문자열을 **쉼표(`,`)** 로만 split  
  → `['["PPT"', '"스토리텔링"', '"슬라이드"]']`  
- 이 배열을 그대로 태그로 쓰면 화면에는 `["PPT"` / `"스토리텔링"` / `"슬라이드"]` 로 보입니다.

---

## 2. Firestore에서 태그가 쓰이는 위치

사이트(프론트)는 **두 군데**에서 태그를 읽습니다.

| 위치 | 컬렉션/문서 경로 | 필드 이름 | 용도 |
|------|------------------|-----------|------|
| **메인 도구 문서** | `ai-tools/{도구ID}` | `tags`, `tagsKr` | 목록/검색, 상세 fallback |
| **Overview 문서** | `ai-tools/{도구ID}/overview/overview` (또는 `details/details`, `info/info`) | `tagKr` | **상세 페이지 태그 우선 사용** |

- **상세 페이지**는 `overview.tagKr` 이 있으면 그걸 쓰고, 없으면 메인 문서의 `tags` 를 씁니다.
- 따라서 `["PPT"` 같은 식으로 보이는 문제는 대부분 **Overview 문서의 `tagKr`** 이 잘못 저장된 경우입니다.

---

## 3. 올바른 형식 vs 잘못된 형식

### ✅ 올바른 형식 (배열)

- **타입**: Firestore **array**
- **값 예시**: `["PPT", "스토리텔링", "슬라이드"]`
- 각 요소는 **문자열 하나** (따옴표/대괄호 없이)

```json
["PPT", "스토리텔링", "슬라이드"]
```

### ❌ 잘못된 형식 1: 문자열로 저장

- **타입**: Firestore **string**
- **값 예시**: `'["PPT", "스토리텔링", "슬라이드"]'`
- 이걸 그대로 쓰거나, 쉼표로만 자르면 화면에 `[` `"` `]` 가 붙어 나옵니다.

### ❌ 잘못된 형식 2: 배열인데 요소가 잘못됨

- **타입**: array
- **값 예시**: `['["PPT"', '"스토리텔링"', '"슬라이드"]']`
- JSON 문자열을 쉼표로 split한 결과를 그대로 저장한 경우입니다.

---

## 4. 확인 방법 (Firebase Console)

1. **Firebase Console** → **Firestore Database** 이동  
2. **메인 도구 문서**  
   - `ai-tools` → 해당 도구 ID 클릭  
   - 필드 `tags`, `tagsKr` 확인  
     - **타입**: 배열(array)  
     - **값**: `"PPT"`, `"스토리텔링"` 처럼 따옴표/대괄호 없이 문자열만  
3. **Overview 문서** (상세 페이지 태그에 영향)  
   - `ai-tools` → 해당 도구 ID → **overview** (서브컬렉션) → **overview** (문서)  
   - 필드 `tagKr` 확인  
     - **타입**: 배열(array)  
     - **값**: 위와 동일하게 문자열만 있는 배열  

`tagKr` 이 **string** 이거나, 배열인데 각 요소에 `[` `"` `]` 가 포함되어 있으면 잘못된 데이터입니다.

---

## 5. 수정 방법

### 방법 A: Firebase Console에서 수동 수정

1. `ai-tools/{도구ID}/overview/overview` 문서 열기  
2. `tagKr` 필드 선택  
3. **타입을 array로**, **값을 아래처럼** 설정  
   - 요소 추가: `PPT`, `스토리텔링`, `슬라이드` (각각 문자열 하나씩, 따옴표/대괄호는 값 안에 넣지 않음)  
4. 저장  

메인 문서의 `tags` / `tagsKr` 도 같은 방식으로 **배열 + 문자열 요소**로 맞추면 됩니다.

### 방법 B: 관리자(Admin)에서 수정 후 Overview와 맞추기

- **AI 도구 관리** 페이지에서 해당 도구 **수정**  
- **태그 (한글)** 에 `PPT, 스토리텔링, 슬라이드` 처럼 **쉼표로만** 입력  
- 저장 시 메인 문서의 `tagsKr` 은 **배열**로 올바르게 저장됩니다.  

단, **상세 페이지는 Overview의 `tagKr`을 우선** 쓰므로,  
Overview 문서를 따로 수정하지 않으면 기존에 잘못된 `tagKr` 이 그대로 보일 수 있습니다.  
이 경우 **방법 A**로 해당 도구의 `overview/overview` 문서 `tagKr` 을 배열로 수정하거나,  
아래 마이그레이션으로 한 번에 고치는 것이 좋습니다.

### 방법 C: 마이그레이션 스크립트로 일괄 수정 (권장)

프로젝트에 **일괄 수정 스크립트**가 포함되어 있습니다.

- **스크립트 경로**: `scripts/fix_tag_storage.py`
- **대상**:  
  - 메인 문서 `ai-tools/{id}` 의 `tags`, `tagsKr`  
  - 서브컬렉션 `overview/overview`, `details/details`, `info/info` 의 `tagKr`
- **로직**: 문자열 → JSON 파싱 후 배열 저장; 배열 요소에 `[` `"` `]` 포함 시 제거 후 저장

**실행 방법** (프로젝트 루트 `ai_curatorhub_admin` 에서):

```bash
# 수정 대상만 확인 (DB 변경 없음)
python scripts/fix_tag_storage.py --dry-run

# 실제 DB 수정
python scripts/fix_tag_storage.py
```

Firebase 인증이 필요합니다. 다음 중 하나를 설정하세요.

- 환경 변수 `FIREBASE_SERVICE_ACCOUNT_KEY_JSON` (서비스 계정 JSON 문자열), 또는  
- 환경 변수 `FIREBASE_SERVICE_ACCOUNT_KEY_PATH` (JSON 키 파일 경로)

---

## 6. 앞으로 저장할 때 주의사항

- **관리자(Admin)**  
  - AI 도구 관리에서 태그는 **쉼표로 구분된 문자열**로 입력하고,  
    코드에서 `tagsKr` / `tagsEn` 를 **배열**로 변환해 메인 문서에 저장하고 있음.  
  - 메인 문서 `tagsKr` 은 **배열**로만 저장하면 됩니다.  
- **Overview 문서**  
  - `tagKr` 은 **반드시 Firestore array**로 저장  
  - 각 요소는 **단순 문자열** (예: `"PPT"`, `"스토리텔링"`)  
  - **문자열 하나** `'["PPT", "스토리텔링", "슬라이드"]'` 로 저장하지 말 것  
- **필드 이름 정리**  
  - 메인 문서: `tagsKr`, `tagsEn`, `tags`  
  - Overview 문서: 사이트 코드가 **`tagKr`**(단수)를 읽음  
  - 새로 Overview를 채울 때는 `tagKr` 필드에 **배열**을 넣으면 됩니다.

---

## 7. 요약

| 항목 | 내용 |
|------|------|
| **원인** | `tagKr`(또는 tags)이 JSON **문자열**로 저장되었거나, 그 문자열을 쉼표로만 잘라 **잘못된 배열**로 씀 |
| **수정 대상** | 주로 `ai-tools/{도구ID}/overview/overview` 의 **tagKr** (그리고 필요 시 메인 문서 **tags** / **tagsKr**) |
| **올바른 형식** | Firestore **array**, 값 예: `["PPT", "스토리텔링", "슬라이드"]` |
| **확인** | Firebase Console에서 해당 문서 열어 `tagKr` 타입·값 확인 |
| **수정** | Console 수동 수정 또는 마이그레이션 스크립트로 잘못된 문자열/배열을 올바른 배열로 일괄 수정 |

프론트에서는 이미 `TagUtils.normalizeTagArray()` 로 **문자열/잘못된 배열**을 보정해 표시하고 있으므로,  
데이터를 위 형식으로 맞춰 두면 화면에는 **PPT**, **스토리텔링**, **슬라이드** 만 깔끔하게 나옵니다.


